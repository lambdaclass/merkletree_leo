circuit Poseidon {
    /*    
    Poseidon for fields
    Takes 2 fields as inputs and generates one output, 
    to use in binary merkle trees

    We base our implementation in the Poseidon RS implementation
    Which itself is based in the sage reference implementation
    https://extgit.iaik.tugraz.at/krypto/hadeshash/-/blob/master/code/poseidonperm_x5_254_3.sage
    
    Constants generated for bls 12 377 using https://extgit.iaik.tugraz.at/krypto/hadeshash/-/blob/master/code/generate_parameters_grain.sage  
    sage generate_parameters_grain.sage 1 0 253 6 8 60 0x12ab655e9a2ca55660b44d1e5c37b00159aa76fed00000010a11800000000001
    then transformed from hexstring array to dec array in python with 
    [int(x,16) for x in c_hexstring]
    [ [ int(x,16) for x in row ] for row in m_string ]

    Notes for paramaters to generate constants:
    Main sub group order / prime number hex
    0x12ab655e9a2ca55660b44d1e5c37b00159aa76fed00000010a11800000000001
    = b0001001...
     -> n = 256 - 3 (zeros) = 253
    sage generate_parameters_grain.sage 1 0 253 3 8 57 0x12ab655e9a2ca55660b44d1e5c37b00159aa76fed00000010a11800000000001
    
    */
    function poseidon_2_1(a_field: field, another_field: field) -> field {
        //t = input len + 1
        const t: u32 = 3;
        const n_rounds_f: u32 = 8;
        // vec![56, 57, 56, 60, 60, 63, 64, 63],
        const n_rounds_p: u32 = 57;
        //Field array of size t
        let state: [field;3] = [0,a_field,another_field];

        for i in 0..(n_rounds_f + n_rounds_p) {
            state = Poseidon::ark(state, i*t);
            state =  Poseidon::sbox(n_rounds_f, n_rounds_p, state, i);
            state = Poseidon::mix(state);
        }
        return state[0];
    }

    function ark(state: [field;3], it: u32 ) -> [field;3]{
        // state[i].add_assign(&c[it + i]);
        const c_constants: [field;195] = 
        [
            1278823093112533518033294982858707370905937792805078104831550399751562346033,
            598603335973957959790020013368266832996149796313558551198244536517632531701,
            8060722710169337072888328444707922391559367908380903829066427594290154256707,
            7146972856962880281734162629778968325765240888605935087654172892267165695133,
            1449562576734101526999810805089074078529161743288468002184137111175162856933,
            1113743120352525446971700625192812102701591418755703996352934957306432699628,
            4571453072040921599889239349307399218088412954681191806362457572834735722303,
            436125143991497637838908305159353642645576904239179033000563345343282195658,
            5469810774020906520807990273354053571703623874728415010718008127670463372224,
            7648571517198168082603302902753129709350741325207889898735329118869923108053,
            3992323220253914597096099762792235978343727615850073062496503773474740846024,
            2478284106106338243872568592095804567247074145295808935048232650372790508705,
            5066508068280387488393441855258010690862455414975149831813065824074010205917,
            5832727626250538312638468690139443975825785919878789118400487255484729997343,
            2034335735908861146864483413976037352830882709954058019263457356828300905909,
            5285395733008462441233046887812168661421402673654710771335415274748653650718,
            8381269884087664415773579100218796643885363929677913502404978021208559320115,
            5141759640002133178493272144302833006504320717636216589929521259086214233541,
            284920817247322128821794962357564304869795981882633159497530127330285657225,
            2654043420004990012234478218688817499739259144293151272063398015590172833563,
            71419072841773181307240376248035656877774482206198239209017753697983554560,
            7896940205262458218977770452313899979396228795249232111041721149179795956761,
            1824353445344357582930028380741749737429248625288519503148242041617386500369,
            6010091602566461943768224701163692495925772031373293593522995018292666138727,
            5111635307134842804323708101428284110474522789935791973711238676978531220975,
            2493218326119648595618695197927838357707669168105318960978684523961052436986,
            144557627624038767361575164712777113487521962446711780778392021604934838191,
            6484464648364857272585154014854213996669659630989387728554560448468065252602,
            3480332546457734859921141597142823093042614459812882747819214182935692024742,
            5864636871201283726655943315535747830421162305900192972669916520458346462949,
            7163286593607129985522824422937839335441797271285495395977696445729808254149,
            3613140595313779240311837031347501341571177424827414726834439482806571947155,
            2591126293423793437218773517284027469484606063224362249259968269998388676171,
            4948311984280480492684768844872094605374509934297189939239794778123271561271,
            230791107342060110124843639085755809081088707833987711382959305433829507501,
            4018600792847753283741108966392783434755636128587466983596625857176198859497,
            2765070331994989806769866944303075773112625038959814497635511904800653654364,
            1473560458398184088520655253682873258886391538929867615440965621935853547082,
            3605034581023271933209940849678126284981790613697842826036202094742022475608,
            4811069186221480362559379184798182450448075234280564624322191856541804429739,
            515323920456365415426626741577827581185256080814130699787042277158196635505,
            7384704537018180191339402380346672718395172051321940519989459821441180932157,
            1149784917208155405827564208079471318659995029650234627129167503093496509650,
            5963196019325868384503355192587262685753372501984884701623029162306486903130,
            3409953790450670465661601971091879548345823754779437592442667286682501165006,
            3139687033275564817940981894137281748613487134797465965810438884691756657468,
            5538429672001647178555397291886353818244058366640615724198158283080248529191,
            189551062111784901255168981100562108188435319833265865170149213846991572561,
            1500206727383055214163878974288971973578818449021894484247049483521288166190,
            6325326557651346301959518753802857476717970124828858724032784496313737028837,
            1692453005855714189506904453593762335831697551570679790146518396966562980778,
            2828123818159769905137092800076117378389983480263321953550685913742955447482,
            5245793665074590542347749583338828429391069522137413882107736636503073148088,
            6329426185792599137935651241371297450204983284206706037988070952734701577763,
            3164582164672130388407961458108524126190836844716529677991308376319541663111,
            7942990179187955241377656348683926735138528349249910986251640114423904815425,
            810715447879515665782496927282148262824110579081611122028520299528282124845,
            3646767408459226076177292550849803496223629550816002325602671109614634788563,
            8274185604234435655374537934494462541565434417589457401903036745923005702652,
            5307355976941655641470259876904224102789412842469813584808872717554392894491,
            7564544347903234158389931231635964401355744464487957071920572278778227632946,
            7647829140976985159212784032826402854411089310548075012922186115475114700201,
            7642273737714794003792024387813731738791251915574110371241397126827377166232,
            8125851533587435027329875979382412183938205048403190672158365507066956838410,
            6323416595543797941473366117595181432626613237408302237782918812116875895203,
            7202183125152619382039083789951898391040094031961370269808229507478374344986,
            2106930330876785305165068118163805934383218843770671188391981737623870108065,
            646081201105643176949930794666281554206898175391985830393146554659401051217,
            2974254453282189500532919865274714715679929437863246163451517816050779350582,
            4325384201633558383815341056317845179093508838215685669723215917899456436577,
            1391885883503386661518755455686343019559627099509877242826039743704721223855,
            710947707169760264880905509763189664189460303989921606511697514969244601880,
            8345787884586849504195826583733783446093212990620319068195226051806491289486,
            1223515481434250348429973730718476044185111004394252199250308639449927622561,
            6472384970709847757196301906609214088193888275700348707884685782166072747031,
            8382975728686912800995523361923156993421830041284552597427964457268616749759,
            5630464437770175177921439020064281018992317943781089612284281251320932120613,
            5798051157217969494651398604297023066590327862548818366182482160399645848420,
            6913533738530907707614860029477606948394634772649989307903269841630489305073,
            6266991030444658268813609578630094877530236632548911479424797142053931839868,
            7130317236953355168396244250700857613808719858940368211501883281865972515700,
            5634425151947005285596506822397228474158348787224274008173699051590283931975,
            2751280442138782964644439227720494529335472736333999921251644776683940119352,
            5500586749941230256150387059790704675004369558145087467404862619699178946460,
            1893852558461923188088235732658886634790465609488763578677311511879341165399,
            3551720514870999436307748739100684657941114253357039693818516332734181414838,
            83913445771544709662199384081446547655948512424201205158330413976790639239,
            3352175966364054071399219172576044393251384489452663944361345968417181735335,
            3697123703652959849539283465599593052549101021828181100522811919801869472672,
            6828413738867071349781202052214448842460238551898619848349094957614243562977,
            3394759295782525752335910381438248392781404638830470939273366056694838418549,
            6673531743631281923541287557053408584842910309925398332650874105551916261115,
            7098120322610558962293701880293582057786574802013398742929567704696514755975,
            8128687166081310577160163363356058521669677550481322667059031187080730655694,
            4035377819010959407676209778005623900329101274925850910851649563673038431054,
            5634260281570210295394365322160350442113953103883642112419493167205596249716,
            920312601458606146235883633359771764314340935990113966181255073112685613210,
            1585239234580559673621884663515065739813526029722354695590834330713580623282,
            6999068827096117538608551251083618889322681306739581957962061210644739594223,
            685998333578173293338005973268482820800634857148865885883514772534691213804,
            7051785919088971846802836632817471248348475587740363025757921279740521893297,
            291943854051674398889309506562579014018804072594199092627250946345991746752,
            41625163768407789157502569986762357393226322719207524610636727739267990170,
            7223269999913177142256760762247972552872691581953983752466763678411230339931,
            6989570265564117949533880815967188206020483967889827893621270569584801110685,
            6681160182093248876637370525691777641404562272003392730071405837730406083581,
            6239156550986803289527418345528608389485409089892584710662368171682299571657,
            3645040064950844951227045997426200957372644028478593732411146709344535602121,
            5445715458179307996487437102826349588636810583089895318457080761706839262648,
            1591077992958372662292505904149136822442396103862920038359523581691218919500,
            7805330981075603816298856169028778892895498933555601370476517918794235281630,
            4418817666873355738323432447154532899587441012249765905780196811629263067686,
            5779420365564704050052455224802705064601212634688286250154350577271379139393,
            1580513429650497473604379632479227927394689025967929492576225762150077007768,
            3093918304127241373075544235961919765094710343032085704048731953858702974777,
            945134064682842505881470076246639049781260132004466782967811462707949130710,
            4238339637349584278079399291483449847509327665904097334760099863731069959996,
            597517943324744151514032828305723480053095199679682156454151319387285277755,
            6541774045551351681349748329413835997501848024348008565919019461727254301874,
            2042787187127235437424668402766531156388232468960622254939718568378711687683,
            5031370406351607176013658272980395735743701627934269193885344115091269021435,
            3752963815355512837072275868333241934760818870195353178559887575807372462639,
            2394571965096250991306833284712774570216743839612831720574069811505981808331,
            7885564090671083976201526826211281308499539528279002519449826775800367455327,
            5910856071574990387373400964139264222635404862105383916528630492204559367097,
            2754854799200959329358166727399990533936123669013493284512071008792994537541,
            2426633822996767008156184707952147141358335167335003031001294694063090257426,
            2393640666357533054400030204112396498645228762998229669104343745292179852379,
            845130614854274958314541430642440585008039461571523133104090934077708527843,
            68435783025975983204306726221704784907907627203607060311224293779986158918,
            7815373160483755999517213015963581599755635996233920310863196074461563213679,
            3022798275319020854941082130953278552865340672545265917059995197552812440832,
            2446644470085970613516332125926585529931477519612558977266514477505498941475,
            2709951297936399305744292811750973118538322082674708852749159058207463922568,
            2644240782500671559806330596113224034690031108280247988116843190411085824827,
            686413035548147641686149455503119690375541234781499432435160343876439683194,
            2558319229341171469715619571892591160406605916963442782295365429699375334280,
            2881782589203801846788519926666270337433325625345079127022341230530628194240,
            4757656631587650149496262276229672565194142156212399054709872824179708442906,
            2970494831363038567294066670352025107487519557443125423088067753524571032042,
            6600177398879804997921433080963479902254355002452744884210629497185401619896,
            2329427266989311550967743153621630697214364995624532665426487779029979385250,
            384719949960273340294838071571671592474952578548587538914598567597776275319,
            3059149228584695498687725144683709772561261185843139195938033131040691334990,
            5502341108679311363511889499295895191061341719435165481718718907874116564305,
            2462809790691170529504370465322991636364470864554479956281496572211465296389,
            1760555032186746652698129233469646057813675507627025483237006422944864665111,
            6512599134031184556349588201505296758972244152385163559097721546679845909058,
            3963818589499253008181493310006314402261788880991236037183191131995088094087,
            6581740737867614578559275057029450714611220405262914328617621103645389208883,
            2592930892502708990957411000966408844175285910538136052931047693327209376412,
            2040558313365468920433135210305049238510970748877211934960879203381485402442,
            4676962242807734046756835978069810940680593611179116715125083348230239628294,
            2486862779554727023840276953407238073335113839524386766314620605263875262651,
            1770547999912496465943439503346139628886755080206196516045117375663948339863,
            4527831804246827040650170222871583077024602828901495272445890567979918273428,
            7936898503091822195446591275440376374995693596477017561512844428791125994309,
            4439964817529294847238282937820844409884472410859888944198626598714658338558,
            837623779071539612715971448271507837346218615408869395300892970815761984257,
            5630466382311290639712531907778693206124656771740549992813912878199546833542,
            2478600926688614234524908478890202689628908698626643439774545758535811294391,
            4527120655508175301816410646609299873838359368474776317042748356010361782540,
            1703320913647274380426835034335357274161904699855268320621798759178696295323,
            5514117542125089860400044583112659986809013890535311855470580719845470632665,
            5612606681894178830222167623969407606927363863157403664583037227130110492299,
            1294805553669220130104712357481169542993730458856501712618639943056268863767,
            3557767678068423322034782930407543407929033983855924871135766936967571368374,
            1140384642974417749562491391641589219791208858715394554001617529224061691553,
            940895369959410331157083068726527666486703143733956984862879352851955219402,
            6160123571176159069053473055285730641798399323099203476988561539240442975560,
            6709336269862743114598451336168898160673111663025619488307440908494434525302,
            7975394830386261671237514364239908627898665554049489398826516879514104428518,
            3692596176953446566611840024344980191845741889189296184484999823522327200506,
            6412097700899768589846653382267914134512985186617454143404683405103100386376,
            4380886761474052835404450614465460344295105746900510959259237650727831732168,
            7912856039419636462788565940943948693555907633654668271029194886298691988969,
            2861039482040651655519016059199423381988180463710778727986060702042485748077,
            6427531190609575696402333245447033029530505596746891758199043631056454990396,
            4046828064186849341050118165580537436486724187749256626650782878439155852469,
            8291142113982014413949806690589810100097604246368361811651899375668345150740,
            3628215024672978994059052663144227394953928450643411382875689527575211945992,
            1350981694597309241113106187102111743886738396344080030769385008521728592593,
            6957495515441757250998899045151266547809958336797159280555671439245366967781,
            2333689190113171690577255007660448278838400951331372640720802360589352318192,
            1210550936859967302996563075984286620282579865378882617078544848865867783322,
            7589248062032095600570050132085657767491236001223339975828143087982141072649,
            6568271255363727221791404426626107494795348309834147335969392785851815997520,
            8255991171863055601992349958187081342314742763164880578695032434148914805599,
            133293465734612308106027587175914530171356810197341356586692341236057628455,
            4370782149387579723185351591496689562069932437985247649096042347699337324673,
            653236030219371523766496787324905884341179706892066208814902003159486415183,
            461666338951881810547792067562862645473597387010896290285087582546580255464,
            1882361624223154326801874995483189739070789519419223050811987441871236361578,
            3697387899308174380037153833961391050851519954181774799874088667757528051966,
            7259004330134201497640522114340206084829571226062210038512363697356639490512
        ];

        let new_state = state;
        for i in 0..3 {
           new_state[i] += c_constants[it + i];
        }
        return new_state;
    }

    function sbox(n_rounds_f: u32, n_rounds_p: u32, state: [field;3], i: u32) -> [field;3]{
        if i < n_rounds_f / 2 || i >= n_rounds_f / 2 + n_rounds_p {
            for j in 0..3 {
                state[j] = state[j]*state[j]*state[j];
            }
        } else {
            state[0] = state[0]*state[0]*state[0];
        }
        return state;
    }

    function mix(state: [field;3]) -> [field;3] {

        const m_constants: [[field; 3]; 3] =
            [
                [
                    5630536360154075049163618594660078512894530511001834381698013113574670071053,
                    4740828481751666806118415198521556454369894530987163711947118257419116566541,
                    6767825761677996714655780100181737845616760880630877959423300205294850186830
                ],
                [
                    1501751275659154471652204340738531774638172500535373735843572838804219693767,
                    1110008737834912556366698871088917574104044019505732383235941372040731142332,
                    4554829589352889939540606765373932095929475033231665803851786425271891096040
                ],
                [
                    3285299094032041669201302424531210296823316899346899015283111155814736482947,
                    6173310781670146243862203680786554434077129307617293689343111030750025600559,
                    5609355908490836216705221571195372566193589029819212913634850154812499303357
                ]
            ];

        for i in 0..3 {
            for j in 0..3 {
                state[i] = m_constants[i][j] * state[j] + m_constants[i][j];
            }
        }
        return state;
    }
}
